#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js'
import dotenv from 'dotenv'
import { fileURLToPath } from 'url'
import { dirname, join } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

// Load environment variables
dotenv.config({ path: join(__dirname, '.env.local') })

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('Missing Supabase environment variables')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseServiceKey)

async function checkAISummaries() {
  try {
    console.log('ðŸ” Checking AI analysis jobs...')

    // Check for any analysis jobs table
    const { data: tables, error: tablesError } = await supabase
      .from('analysis_jobs')
      .select('*')
      .limit(1)

    if (tablesError) {
      console.log('âŒ No analysis_jobs table found:', tablesError.message)

      // Check for any AI-related content
      console.log('\nðŸ” Checking for AI-generated content in profiles...')

      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('id, display_name, bio')
        .not('bio', 'is', null)
        .limit(10)

      if (!profilesError && profiles) {
        console.log(`ðŸ“Š Found ${profiles.length} profiles with bios (showing first 10)`)

        const aiIndicators = ['AI-generated', 'generated by', 'artificial intelligence', 'This bio was created']
        let aiGeneratedCount = 0

        profiles.forEach(profile => {
          const hasAIContent = aiIndicators.some(indicator =>
            profile.bio?.toLowerCase().includes(indicator.toLowerCase())
          )
          if (hasAIContent) {
            aiGeneratedCount++
            console.log(`ðŸ¤– AI-generated content found: ${profile.display_name}`)
          }
        })

        console.log(`\nðŸ“ˆ Summary:`)
        console.log(`- Profiles with bios: ${profiles.length}+`)
        console.log(`- AI-generated content detected: ${aiGeneratedCount}`)
      }

      return
    }

    // Count analysis jobs by type
    const { data: jobs, error: jobsError } = await supabase
      .from('analysis_jobs')
      .select('job_type, status, completed_at')

    if (jobsError) {
      console.error('Error fetching analysis jobs:', jobsError)
      return
    }

    if (!jobs || jobs.length === 0) {
      console.log('ðŸ“ No AI analysis jobs found in database')
      return
    }

    console.log(`ðŸ“Š Found ${jobs.length} total AI analysis jobs`)

    // Group by job type
    const jobTypes = {}
    jobs.forEach(job => {
      if (!jobTypes[job.job_type]) {
        jobTypes[job.job_type] = { total: 0, completed: 0, recent: 0 }
      }
      jobTypes[job.job_type].total++
      if (job.status === 'completed') {
        jobTypes[job.job_type].completed++
      }

      // Check if completed in last 30 days
      if (job.completed_at) {
        const completedDate = new Date(job.completed_at)
        const thirtyDaysAgo = new Date()
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

        if (completedDate > thirtyDaysAgo) {
          jobTypes[job.job_type].recent++
        }
      }
    })

    console.log('\nðŸ“ˆ Analysis Jobs by Type:')
    Object.entries(jobTypes).forEach(([type, stats]) => {
      console.log(`  ${type}:`)
      console.log(`    - Total: ${stats.total}`)
      console.log(`    - Completed: ${stats.completed}`)
      console.log(`    - Recent (30 days): ${stats.recent}`)
    })

    // Check specifically for profile enhancement and content quality jobs
    const profileEnhancementJobs = jobs.filter(j => j.job_type === 'profile_enhancement')
    const contentQualityJobs = jobs.filter(j => j.job_type === 'content_quality_analysis')
    const bioRegenerationJobs = jobs.filter(j => j.job_type === 'bio_regeneration')

    console.log('\nðŸŽ¯ AI Profile Enhancement Summary:')
    console.log(`  - Profile enhancement jobs: ${profileEnhancementJobs.length}`)
    console.log(`  - Content quality analyses: ${contentQualityJobs.length}`)
    console.log(`  - Bio regeneration jobs: ${bioRegenerationJobs.length}`)

  } catch (error) {
    console.error('Error checking AI summaries:', error)
  }
}

checkAISummaries()